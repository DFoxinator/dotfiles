# Output the number of current jobs running in the background
function __ps1_exit_status() {
	local exit_status=$1
	[ $exit_status -ne 0 ] && echo -n "E:${exit_status} "
}

# Output the number of current jobs running in the background
function __ps1_jobs_run() {
	local job_count=$1
	[ $job_count -gt 0 ] && echo -n "bg:${job_count} "
}

# Output information about the current directory's repository
function __ps1_repo_info() {
	type __git_ps1 &> /dev/null && __git_ps1 "$@"
}

# generate the bash prompt
function __ps1_create() {
	# load avg colorization
	local loadavg='
		load=$(__ps1_proc_use);
		if [ "$DOTENV" == "cygwin" ]; then
			loadmod=$(expr $(echo "${load}" | sed "s/^0*\([0-9]\+\)\..\+\$/\1/") / 10 )
		else
			loadmod=$(echo "${load}" | sed "s/^0*\([0-9]\+\)\..\+\$/\1/")
		fi
		if [ $loadmod -gt 9 ]; then
			loadmod=9
		fi
		loadcolors=(
			"\[\e[38;5;159m\]"
			"\[\e[38;5;153m\]"
			"\[\e[38;5;152m\]"
			"\[\e[38;5;146m\]"
			"\[\e[38;5;145m\]"
			"\[\e[38;5;139m\]"
			"\[\e[38;5;138m\]"
			"\[\e[38;5;137m\]"
			"\[\e[38;5;131m\]"
			"\[\e[38;5;124m\]"
		)
		echo "${loadcolors[$loadmod]}$load\[\e[0m\] "
	';
	
	# datetime colorization
	local datetime='
		
	';

	# Start PS1 description
	PS1=''
	# open bracket
	PS1="$PS1"'['
	# show exit code
	PS1="$PS1"'\[\e[38;5;196m\]$(__ps1_exit_status "$?")\[\e[0m\]'
	# show number of background jobs
	PS1="$PS1"'\[\e[0;36m\]$(__ps1_jobs_run "\j")\[\e[0m\]'
	# time
	PS1="$PS1"'\[\e[37m\]\T\[\e[0m\] '
	# load
	PS1="$PS1\$($loadavg)"
	# user
	PS1="$PS1"'\[\e[32m\]\u\[\e[0m\]'
	# [@] based on environment
	# If ssh connection
	if [ -n "${SSH_CONNECTION:-}" ]; then
		PS1="$PS1"'@'
	else
		# otherwise
		PS1="$PS1"'#'
	fi
	# [host|screen session]
	if [ "$TERM" != "screen" ]; then
		PS1="$PS1"'\[\e[32m\]\h\[\e[0m\]'
	else
		# otherwise
		PS1="$PS1"'\[\e[32;4m\]$STY\[\e[0m\]'
	fi
	# space
	PS1="$PS1"' '
	# working directory
	PS1="$PS1"'\[\e[33m\]\W\[\e[0m\]'
	# git status
	PS1="$PS1"'\[\e[31m\]$(__ps1_repo_info " (%s)")\[\e[0m\]'
	# close bracket
	PS1="$PS1"']\$ '

	# Set the title bar if we are in xterm
	case "$TERM" in
		xterm*|rxvt*)
			PS1="\[\e]0;\u@\h:\W\007\]$PS1"
			;;
		*)
			;;
	esac
}
# Execute the prompt creation function
__ps1_create
export PS1
unset __ps1_create

# show git status
export GIT_PS1_SHOWDIRTYSTATE=true
export GIT_PS1_SHOWSTASHSTATE=true
export GIT_PS1_SHOWUNTRACKEDFILES=true
export GIT_PS1_SHOWUPSTREAM="auto"
